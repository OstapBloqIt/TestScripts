# USB and RS485 Validation Tools

This directory contains tools for validating USB enumeration, CP2104/CP2108 devices, and RS485 transceivers on the iMX8M Mini Verdin SoM.

## Files

- **`usb_rs485_validator.sh`** - Automated validation script that collects system data and generates comprehensive markdown reports
- **`USB_RS485_Validation_Report.md`** - Initial manual validation report (baseline reference)
- **`README.md`** - This file

## Quick Start

### Running the Validation Script

```bash
# Run with default timestamped output filename
./usb_rs485_validator.sh

# Run with custom output filename
./usb_rs485_validator.sh my_custom_report.md
```

### Script Features

The validation script automatically:

1. ✅ Collects USB device enumeration data
2. ✅ Validates CP2108 Quad UART Bridge detection
3. ✅ Checks for CP2104 device presence
4. ✅ Verifies RS485 transceiver channels (ttyUSB0-3)
5. ✅ Examines USB hub configuration
6. ✅ Gathers kernel driver information
7. ✅ Analyzes kernel messages for device detection
8. ✅ Generates a comprehensive markdown report

### Output

The script produces:

- **Console Summary**: Color-coded status of key components
- **Markdown Report**: Comprehensive validation report with:
  - Executive summary with key findings
  - USB topology and device tree
  - Detailed device information
  - Interface mappings for CP2108
  - RS485 channel status
  - Kernel driver status
  - Recommendations for issues found

### Example Output

```
==========================================
           VALIDATION SUMMARY
==========================================
CP2108 Status: FOUND
CP2104 Status: NOT CONNECTED
RS485 Channels: 4/4
USB Hub Status: FOUND
==========================================
```

## Expected Hardware Configuration

### USB Topology

```
iMX8M Mini (USB Bus 2)
└── Microchip USB Hub (0424:2517)
    ├── Port 5: CP2108 Quad UART Bridge (10c4:ea71)
    │   ├── Interface 0 → ttyUSB0 (RS485 Channel 0)
    │   ├── Interface 1 → ttyUSB1 (RS485 Channel 1)
    │   ├── Interface 2 → ttyUSB2 (RS485 Channel 2)
    │   └── Interface 3 → ttyUSB3 (RS485 Channel 3)
    └── Port 1: CP2104 (10c4:ea60) [Optional]
```

### Device IDs

- **USB Hub**: Vendor ID `0424`, Product ID `2517` (Microchip)
- **CP2108**: Vendor ID `10c4`, Product ID `ea71` (Silicon Labs)
- **CP2104**: Vendor ID `10c4`, Product ID `ea60` (Silicon Labs)

## Troubleshooting

### CP2104 Not Detected

If the CP2104 shows as disconnected:

1. Check physical USB connection to the hub
2. Verify power supply to the device
3. Inspect USB cable and connectors
4. Check kernel messages: `dmesg | grep cp210`
5. Re-run validation after securing connection

### RS485 Channels Missing

If not all 4 RS485 channels are detected:

1. Verify CP2108 is properly detected
2. Check kernel driver is loaded: `lsmod | grep cp210x`
3. Examine sysfs: `ls /sys/class/tty/ttyUSB*`
4. Review kernel messages for errors

### Script Permissions

If you get a permission denied error:

```bash
chmod +x usb_rs485_validator.sh
```

## System Requirements

- **Platform**: Toradex Verdin iMX8M Mini
- **OS**: Torizon Core 6.8.1 or compatible
- **Kernel**: Linux 5.15.148 or compatible
- **Required Commands**: lsusb, dmesg, grep, find, ls

## Report Sections

Generated reports include:

1. **Executive Summary** - Quick overview of validation status
2. **USB Topology** - Visual representation of USB device tree
3. **USB Hub Validation** - Hub details and port configuration
4. **CP2108 Validation** - Quad UART bridge status and interface mapping
5. **CP2104 Status** - Single UART status and detection history
6. **RS485 Validation** - Channel-by-channel status
7. **Serial Device Summary** - All ttyUSB devices
8. **Kernel Driver Status** - Driver loading and binding information
9. **Validation Results** - Pass/fail summary table
10. **Recommendations** - Actionable steps for any issues found
11. **System Information** - Kernel and platform details

## Notes

- The script creates temporary files in `/tmp/usb_validation_$$` (automatically cleaned up)
- Running as root is recommended for full system access
- The script is safe to run multiple times
- Each run generates a new report (default filename includes timestamp)
- No system modifications are made (read-only operations)

## Support

For issues or questions:

1. Review the generated validation report
2. Check kernel messages: `dmesg | grep -i usb`
3. Verify hardware connections
4. Re-run the validation script after any changes

---

**Generated by**: Claude Code
**Version**: 1.0
**Last Updated**: 2025-10-13
